<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-128x128.png" sizes="128x128">
  <link rel="icon" type="image/png" href="/favicon-180x180.png" sizes="180x180">
  <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
  <title>Image generation tools</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #c4a000; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #000000; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #000000; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    html {
        background-color: #eee;
    }
    body {
        margin: 0 auto;
        max-width: 50em;
        padding: 1em;
    }
    h1, h2, h3, h4, h5, h6 {
        color: #111;
    }  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Image generation tools</h1>
</header>
<h1 id="prelude">Prelude</h1>
<h2 id="inclusion">Inclusion</h2>
<p>The following script uses LitLib's <code
class="verbatim">include.pl</code> to fetch code blocks defined in <code
class="verbatim">Yliss</code> and <code class="verbatim">LitLib</code>,
along with their dependencies. Most of the work to generate images is
defined in in those other documents, the current document merely
assembles a few primitives.</p>
<p><strong><code class="verbatim">include</code></strong></p>
<div class="sourceCode" id="include" data-org-language="sh"
data-var="args=&quot;&quot;" data-results="output" wrap="src cpp"
data-eval="no-export"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="include-1"><a href="#include-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./litlib/include.pl</span> <span class="st">&#39;window.org litlib/cpp.org graphics.org imgen.org&#39;</span> <span class="st">&quot;</span><span class="va">$args</span><span class="st">&quot;</span></span></code></pre></div>
<h1 id="image-specification-imgspec">Image specification (<code
class="verbatim">imgspec</code>)</h1>
<p>Gathers all the information needed to generate an image, with
reasonable defaults for the vertex and fragment shaders.</p>
<p><strong><code class="verbatim">imgspec</code></strong></p>
<div class="sourceCode" id="imgspec"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="imgspec-1"><a href="#imgspec-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> imgspec <span class="op">{</span></span>
<span id="imgspec-2"><a href="#imgspec-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>vs <span class="op">=</span></span>
<span id="imgspec-3"><a href="#imgspec-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#version 330 core</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-4"><a href="#imgspec-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;layout (location = 0) in vec2 position;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-5"><a href="#imgspec-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;layout (location = 1) in vec3 color_in;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-6"><a href="#imgspec-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;out vec3 color_fs;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-7"><a href="#imgspec-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-8"><a href="#imgspec-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;uniform mat4 model;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-9"><a href="#imgspec-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;uniform mat4 view;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-10"><a href="#imgspec-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;uniform mat4 projection;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-11"><a href="#imgspec-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-12"><a href="#imgspec-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;void main() {</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-13"><a href="#imgspec-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;    gl_Position = projection * view * model * vec4(position, 0.0f, 1.0f);</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-14"><a href="#imgspec-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;    color_fs = color_in;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-15"><a href="#imgspec-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;}</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="imgspec-16"><a href="#imgspec-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>fs <span class="op">=</span></span>
<span id="imgspec-17"><a href="#imgspec-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;#version 330 core</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-18"><a href="#imgspec-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;out vec4 color_out;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-19"><a href="#imgspec-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;in vec3 color_fs;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-20"><a href="#imgspec-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-21"><a href="#imgspec-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;void main() {</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-22"><a href="#imgspec-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;    color_out = vec4(color_fs, 1.);</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="imgspec-23"><a href="#imgspec-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;}</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="imgspec-24"><a href="#imgspec-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;&amp;</span> vtx<span class="op">;</span></span>
<span id="imgspec-25"><a href="#imgspec-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">&gt;&amp;</span> layout<span class="op">;</span></span>
<span id="imgspec-26"><a href="#imgspec-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">&gt;&amp;</span> idx<span class="op">;</span></span>
<span id="imgspec-27"><a href="#imgspec-27" aria-hidden="true" tabindex="-1"></a>    orthographic_projection proj<span class="op">{.</span>left <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="op">.</span>right <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">.</span>bottom <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="op">.</span>top <span class="op">=</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="imgspec-28"><a href="#imgspec-28" aria-hidden="true" tabindex="-1"></a>    mandatory<span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">&gt;</span> width<span class="op">;</span></span>
<span id="imgspec-29"><a href="#imgspec-29" aria-hidden="true" tabindex="-1"></a>    mandatory<span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">&gt;</span> height<span class="op">;</span></span>
<span id="imgspec-30"><a href="#imgspec-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgspec-31"><a href="#imgspec-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>imgspec<span class="op">/</span><span class="kw">public</span><span class="op">&gt;&gt;</span></span>
<span id="imgspec-32"><a href="#imgspec-32" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The <code class="verbatim">gen</code> method can generate an image
under the given path by creating an OpenGL context and rendering one
frame using the information contained in the <code
class="verbatim">imgspec</code>.</p>
<p>Addition to <strong><code
class="verbatim">imgspec/public</code></strong></p>
<div class="sourceCode" id="cb1" data-eval="no-export"
data-exports="both" data-noweb-ref="imgspec/public"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> gen<span class="op">(</span><span class="bu">std::</span>string_view<span class="op"> </span>destination<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    gl_context offscreen<span class="op">(*</span>width<span class="op">,</span> <span class="op">*</span>height<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    glClearColor<span class="op">(</span><span class="fl">.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">.5</span><span class="bu">f</span><span class="op">,</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    shader_program shader<span class="op">{</span>vertex_shader<span class="op">(</span>vs<span class="op">),</span> fragment_shader<span class="op">(</span>fs<span class="op">)};</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    VAO vao<span class="op">{};</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    vertices<span class="op">&lt;</span>GLfloat<span class="op">&gt;</span> vtxobj<span class="op">(</span>vtx<span class="op">,</span> layout<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    indexes idxobj<span class="op">(</span>idx<span class="op">);</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    moviort viper<span class="op">(</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">(),</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">().</span>translate<span class="op">({</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">}),</span> <span class="co">// Move the view otherwise it would get clipped by the near value.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        proj<span class="op">,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        shader</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> render <span class="op">=</span> <span class="op">[&amp;]{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        shader<span class="op">.</span>use<span class="op">();</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        vao<span class="op">.</span>bind<span class="op">();</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        idxobj<span class="op">.</span>draw<span class="op">();</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> writer <span class="op">=</span> image<span class="op">::</span>format<span class="op">::</span>deduce<span class="op">&lt;</span><span class="dv">90</span><span class="op">&gt;::</span>writer<span class="op">&lt;</span>identity<span class="op">&gt;;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    gl_screen_one<span class="op">(</span>offscreen<span class="op">,</span> destination<span class="op">,</span> writer<span class="op">(),</span> render<span class="op">);</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="usage">Usage</h2>
<div class="sourceCode" id="cb2" data-eval="no-export"
data-exports="both"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>include<span class="op">(</span><span class="st">&quot;:noweb imgspec&quot;</span><span class="op">)&gt;&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    imgspec<span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>vtx <span class="op">=</span> <span class="op">{</span> <span class="co">// Positions // Colors</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span>        <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>  <span class="co">// Top right,    yellow.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span>        <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span>  <span class="co">// Top left,     magenta.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>        <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span>  <span class="co">// Bottom right, cyan.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>        <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="co">// Bottom left,  black.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>layout <span class="op">=</span> <span class="op">{</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span> <span class="op">},</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>idx <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                 <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span> <span class="op">},</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>width <span class="op">=</span> <span class="dv">64</span><span class="op">,</span> <span class="op">.</span>height <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>gen<span class="op">(</span><span class="st">&quot;images/imgen/usage.png&quot;</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="RESULTS drawer">
<p><img src="images/imgen/usage.png" /></p>
</div>
<h2 id="command-line-tool">Command-line tool</h2>
<p>The goal is to write a tool able to read this kind of image
specification format:</p>
<div class="sourceCode" id="cb3" data-tangle="tangle/usage.imgspec"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>1 1 1 1 0</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>0 1 1 0 1</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>1 0 0 1 1</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>0 0 0 0 0</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>2 3</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>0 1 2</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>1 2 3</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>64 64</span></code></pre></div>
<p>This format is composed of 4 section separated by empty lines:</p>
<ol>
<li>The vertices.</li>
<li>The layout.</li>
<li>The indexes.</li>
<li>The size of the generated image.</li>
</ol>
<h3 id="implementation">Implementation</h3>
<p><strong><code class="verbatim">imgen-cli</code></strong></p>
<div class="sourceCode" id="imgen-cli"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="imgen-cli-1"><a href="#imgen-cli-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> is_space<span class="op">(</span><span class="dt">char</span> c<span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-2"><a href="#imgen-cli-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c <span class="op">==</span> <span class="ch">&#39; &#39;</span> <span class="op">||</span> c <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="imgen-cli-3"><a href="#imgen-cli-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="imgen-cli-4"><a href="#imgen-cli-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-5"><a href="#imgen-cli-5" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> not_spaces<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string_view<span class="op"> </span>str<span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-6"><a href="#imgen-cli-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="kw">auto</span> c<span class="op">:</span> str<span class="op">)</span></span>
<span id="imgen-cli-7"><a href="#imgen-cli-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>is_space<span class="op">(</span>c<span class="op">))</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="imgen-cli-8"><a href="#imgen-cli-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="imgen-cli-9"><a href="#imgen-cli-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="imgen-cli-10"><a href="#imgen-cli-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-11"><a href="#imgen-cli-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span> <span class="op">{</span></span>
<span id="imgen-cli-12"><a href="#imgen-cli-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>argc <span class="op">!=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-13"><a href="#imgen-cli-13" aria-hidden="true" tabindex="-1"></a>        panic<span class="op">(</span><span class="st">&quot;expected 2 arguments, got &quot;</span> <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>argc<span class="op">-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="imgen-cli-14"><a href="#imgen-cli-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="imgen-cli-15"><a href="#imgen-cli-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> spec <span class="op">=</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="imgen-cli-16"><a href="#imgen-cli-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> dest <span class="op">=</span> argv<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="imgen-cli-17"><a href="#imgen-cli-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-18"><a href="#imgen-cli-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> cleansplit <span class="op">=</span> <span class="op">[](</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> range<span class="op">,</span> <span class="kw">auto</span> splitter<span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-19"><a href="#imgen-cli-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> res <span class="op">=</span> split<span class="op">(</span>range<span class="op">,</span> splitter<span class="op">);</span></span>
<span id="imgen-cli-20"><a href="#imgen-cli-20" aria-hidden="true" tabindex="-1"></a>        keepin<span class="op">(</span>not_spaces<span class="op">,</span> res<span class="op">);</span></span>
<span id="imgen-cli-21"><a href="#imgen-cli-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res<span class="op">;</span></span>
<span id="imgen-cli-22"><a href="#imgen-cli-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="imgen-cli-23"><a href="#imgen-cli-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-24"><a href="#imgen-cli-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> raw <span class="op">=</span> slurp<span class="op">(</span>spec<span class="op">);</span> <span class="co">// </span><span class="al">TODO</span><span class="co">: ensure it exists.</span></span>
<span id="imgen-cli-25"><a href="#imgen-cli-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> splitted <span class="op">=</span> cleansplit<span class="op">(</span>raw<span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="imgen-cli-26"><a href="#imgen-cli-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-27"><a href="#imgen-cli-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>splitted<span class="op">.</span>size<span class="op">()</span> <span class="op">!=</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-28"><a href="#imgen-cli-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string<span class="op"> </span>err <span class="op">=</span> <span class="st">&quot;expected 4 sections to imgspec file but got &quot;</span><span class="op">;</span></span>
<span id="imgen-cli-29"><a href="#imgen-cli-29" aria-hidden="true" tabindex="-1"></a>        panic<span class="op">(</span>err <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>splitted<span class="op">.</span>size<span class="op">()));</span></span>
<span id="imgen-cli-30"><a href="#imgen-cli-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="imgen-cli-31"><a href="#imgen-cli-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-32"><a href="#imgen-cli-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> parse <span class="op">=</span> <span class="op">[&amp;](</span><span class="kw">auto</span> i<span class="op">,</span> <span class="kw">auto</span> convert<span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-33"><a href="#imgen-cli-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mapassert<span class="op">(</span>convert<span class="op">,</span> cleansplit<span class="op">(</span>splitted<span class="op">[</span>i<span class="op">],</span> greedy_finder<span class="op">(</span>is_space<span class="op">)));</span></span>
<span id="imgen-cli-34"><a href="#imgen-cli-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="imgen-cli-35"><a href="#imgen-cli-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-36"><a href="#imgen-cli-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> vertices <span class="op">=</span> parse<span class="op">(</span><span class="dv">0</span><span class="op">,</span> to_float<span class="op">);</span></span>
<span id="imgen-cli-37"><a href="#imgen-cli-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> layout <span class="op">=</span> parse<span class="op">(</span><span class="dv">1</span><span class="op">,</span> to_uint<span class="op">);</span></span>
<span id="imgen-cli-38"><a href="#imgen-cli-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> indexes <span class="op">=</span> parse<span class="op">(</span><span class="dv">2</span><span class="op">,</span> to_uint<span class="op">);</span></span>
<span id="imgen-cli-39"><a href="#imgen-cli-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> imsize <span class="op">=</span> parse<span class="op">(</span><span class="dv">3</span><span class="op">,</span> to_uint<span class="op">);</span></span>
<span id="imgen-cli-40"><a href="#imgen-cli-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-41"><a href="#imgen-cli-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>imsize<span class="op">.</span>size<span class="op">()</span> <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="imgen-cli-42"><a href="#imgen-cli-42" aria-hidden="true" tabindex="-1"></a>        panic<span class="op">(</span><span class="bu">std::</span>string<span class="op">(</span><span class="st">&quot;expected image size section to be 2 uint, got&quot;</span><span class="op">)</span> <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>imsize<span class="op">.</span>size<span class="op">()));</span></span>
<span id="imgen-cli-43"><a href="#imgen-cli-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="imgen-cli-44"><a href="#imgen-cli-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-45"><a href="#imgen-cli-45" aria-hidden="true" tabindex="-1"></a>    imgspec<span class="op">{</span></span>
<span id="imgen-cli-46"><a href="#imgen-cli-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>vtx <span class="op">=</span> vertices<span class="op">,</span></span>
<span id="imgen-cli-47"><a href="#imgen-cli-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>layout <span class="op">=</span> layout<span class="op">,</span></span>
<span id="imgen-cli-48"><a href="#imgen-cli-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>idx <span class="op">=</span> indexes<span class="op">,</span></span>
<span id="imgen-cli-49"><a href="#imgen-cli-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>width <span class="op">=</span> imsize<span class="op">[</span><span class="dv">0</span><span class="op">],</span></span>
<span id="imgen-cli-50"><a href="#imgen-cli-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>height <span class="op">=</span> imsize<span class="op">[</span><span class="dv">1</span><span class="op">],</span></span>
<span id="imgen-cli-51"><a href="#imgen-cli-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>gen<span class="op">(</span>dest<span class="op">);</span></span>
<span id="imgen-cli-52"><a href="#imgen-cli-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="imgen-cli-53"><a href="#imgen-cli-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="imgen-cli-54"><a href="#imgen-cli-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="compilation">Compilation</h3>
<p>This compiles <code class="verbatim">imgen</code> into <code
class="verbatim">./bin</code>:</p>
<div class="sourceCode" id="cb4" wrap="src compilation"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> bin</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">tangled</span><span class="op">=</span>tangle/imgen.cpp</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./litlib/include.pl</span> <span class="st">&#39;window.org litlib/cpp.org graphics.org imgen.org&#39;</span> <span class="st">&#39;:noweb imgen-cli&#39;</span> <span class="op">&gt;</span> <span class="va">$tangled</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> <span class="at">-Wall</span> <span class="at">-std</span><span class="op">=</span>c++20 <span class="at">-O2</span> <span class="at">-I</span> include <span class="at">-lGL</span> <span class="at">-lOSMesa</span> src/glad.c <span class="va">$tangled</span> <span class="at">-o</span> bin/imgen</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">du</span> <span class="at">-sh</span> bin/imgen</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> <span class="va">$tangled</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="va">$tangled</span></span></code></pre></div>
<h3 id="code-block">Code block</h3>
<p><strong><code class="verbatim">imgen</code></strong></p>
<div class="sourceCode" id="imgen"
data-var="spec=&quot;&quot; dest=&quot;&quot;"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="imgen-1"><a href="#imgen-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[[</span> <span class="ot">-f</span> <span class="st">&quot;</span><span class="va">$spec</span><span class="st">&quot;</span> <span class="kw">]]</span> <span class="kw">||</span> <span class="kw">{</span> <span class="bu">echo</span> <span class="st">&quot;Specification file </span><span class="dt">\`</span><span class="va">$spec</span><span class="dt">\`</span><span class="st"> does not exist.&quot;</span><span class="kw">;</span> <span class="bu">exit</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="imgen-2"><a href="#imgen-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$(</span><span class="fu">dirname</span> <span class="st">&quot;</span><span class="va">$dest</span><span class="st">&quot;</span><span class="va">)</span><span class="st">&quot;</span></span>
<span id="imgen-3"><a href="#imgen-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./bin/imgen</span> <span class="st">&quot;</span><span class="va">$spec</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$dest</span><span class="st">&quot;</span></span></code></pre></div>
<div class="RESULTS drawer">
<p><img src="images/imgen/usage.png" /></p>
</div>
<h1 id="image-specification-generation-pymgen">Image specification
generation (<code class="verbatim">pymgen</code>)</h1>
<p>The idea is to use an expressive language with fast compilation or
fast enough interpretation to quickly output image specifications. This
implementation is based on Python and is called <code
class="verbatim">pymgen</code>.</p>
<p>The proper implementation is splitted into three parts:</p>
<ol>
<li><strong>Primitives</strong> not directly related to image
generation.</li>
<li><strong>Generation</strong> of the imgspec data.</li>
<li><strong>Definition</strong> of the image to generate.</li>
</ol>
<p>Two additional sections, <strong>Code blocks</strong> and
<strong>Usage</strong> are appended at the end to set up code blocks and
to show <code class="verbatim">pymgen</code> in action.</p>
<h2 id="primitives">Primitives</h2>
<p><code class="verbatim">enumerator</code> automatically associates an
increasing number to the keys that have not been defined yet. It can be
seen as an handy way to associate a numerical index to potentially
duplicated data points.</p>
<p><strong><code class="verbatim">enumerator</code></strong></p>
<div class="sourceCode" id="enumerator"><pre
class="sourceCode python"><code class="sourceCode python"><span id="enumerator-1"><a href="#enumerator-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> enumerator(<span class="bu">dict</span>):</span>
<span id="enumerator-2"><a href="#enumerator-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="enumerator-3"><a href="#enumerator-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.i <span class="op">=</span> <span class="dv">0</span></span>
<span id="enumerator-4"><a href="#enumerator-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, key):</span>
<span id="enumerator-5"><a href="#enumerator-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="va">self</span>:</span>
<span id="enumerator-6"><a href="#enumerator-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">super</span>().<span class="fu">__getitem__</span>(key)</span>
<span id="enumerator-7"><a href="#enumerator-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>[key] <span class="op">=</span> <span class="va">self</span>.i</span>
<span id="enumerator-8"><a href="#enumerator-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="enumerator-9"><a href="#enumerator-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.i <span class="op">-</span> <span class="dv">1</span></span></code></pre></div>
<p>Usage:</p>
<div class="sourceCode" id="cb5" data-exports="both"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>include(<span class="st">&quot;:noweb enumerator&quot;</span>)<span class="op">&gt;&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lost <span class="op">=</span> enumerator()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>indexes <span class="op">=</span> [lost[i] <span class="cf">for</span> i <span class="kw">in</span> (<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">23</span>, <span class="dv">42</span>, <span class="dv">16</span>, <span class="dv">16</span>, <span class="dv">16</span>, <span class="dv">42</span>, <span class="dv">108</span>)]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(indexes)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(lost)</span></code></pre></div>
<div class="RESULTS drawer">
<p>[0, 1, 2, 3, 4, 5, 3, 3, 3, 5, 6] {4: 0, 8: 1, 15: 2, 16: 3, 23: 4,
42: 5, 108: 6}</p>
</div>
<h2 id="generation">Generation</h2>
<p>Generation is mainly concerned with two things:</p>
<ol>
<li>Ensuring that the initial definition is correct.</li>
<li>Transforming this definition to a textual specification.</li>
</ol>
<h3 id="vertices">Vertices</h3>
<p>Vertices can be defined with the <code class="verbatim">vertex</code>
class. The main design principle is to not bother with error handling.
If there is an error, execution is immediately stopped.</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb6" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> vertex:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>spec):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> assert5():</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> <span class="bu">tuple</span>(spec)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(spec) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                s <span class="op">=</span> spec[<span class="dv">0</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(s) <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">list</span>(s) <span class="op">+</span> [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="co"># Black.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> <span class="bu">len</span>(s) <span class="op">==</span> <span class="dv">5</span>, <span class="ss">f&quot;invalid vertex spec `</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">`&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> s</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        spec <span class="op">=</span> assert5()</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x, <span class="va">self</span>.y, <span class="va">self</span>.r, <span class="va">self</span>.g, <span class="va">self</span>.b <span class="op">=</span> spec</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39; &#39;</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, (<span class="va">self</span>.x, <span class="va">self</span>.y, <span class="va">self</span>.r, <span class="va">self</span>.g, <span class="va">self</span>.b)))</span></code></pre></div>
<h2 id="assembly-of-vertices">Assembly of vertices</h2>
<p>This is the last step of image specification generation,
instantiating the raw vertices into text. The main geometric primitive
is the triangle, defined as sequences of 3 vertices. <code
class="verbatim">triangle</code>'s role is to assert that its argument
is indeed a sequence of 3 vertices and to convert each of those vertices
to strings (ultimately relying on <code class="verbatim">vertex</code>
to do so).</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb7" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> triangle(spec):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(spec) <span class="op">==</span> <span class="dv">3</span>, <span class="ss">f&#39;invalid triangle spec </span><span class="sc">{</span>spec<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(vertex(spec[<span class="dv">0</span>])), <span class="bu">str</span>(vertex(spec[<span class="dv">1</span>])), <span class="bu">str</span>(vertex(spec[<span class="dv">2</span>]))</span></code></pre></div>
<p>The ultimate function of the specification generation part is <code
class="verbatim">imgspec</code>, which takes a sequence of triangles and
turns it into an image specification. Unique, non-duplicated indexes are
attributed via an instance of <code class="verbatim">enumerator</code>,
which is quite neat.</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb8" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> imgspec(triangles, width, height):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    vertices <span class="op">=</span> enumerator()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    indexes <span class="op">=</span> [ <span class="st">&#39; &#39;</span>.join(<span class="bu">str</span>(vertices[vtx]) <span class="cf">for</span> vtx <span class="kw">in</span> triangle(tri))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> tri <span class="kw">in</span> triangles ]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(vertices.keys()))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(indexes))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(width, height)</span></code></pre></div>
<h2 id="definition">Definition</h2>
<p>This part is concerned with setting up primitives to help defining
and combining geometric shapes.</p>
<h3 id="predefined-constants">Predefined constants</h3>
<p>Positions:</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb9" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lt <span class="op">=</span> left_top      <span class="op">=</span> (<span class="dv">0</span>,   <span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rt <span class="op">=</span> right_top     <span class="op">=</span> (<span class="dv">1</span>,   <span class="dv">1</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>lb <span class="op">=</span> left_bottom   <span class="op">=</span> (<span class="dv">0</span>,   <span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>rb <span class="op">=</span> right_bottom  <span class="op">=</span> (<span class="dv">1</span>,   <span class="dv">0</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>mt <span class="op">=</span> middle_top    <span class="op">=</span> (<span class="fl">0.5</span>, <span class="dv">1</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>mb <span class="op">=</span> middle_bottom <span class="op">=</span> (<span class="fl">0.5</span>, <span class="dv">0</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>lm <span class="op">=</span> left_middle   <span class="op">=</span> (<span class="dv">0</span>,   <span class="fl">0.5</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>rm <span class="op">=</span> right_middle  <span class="op">=</span> (<span class="dv">1</span>,   <span class="fl">0.5</span>)</span></code></pre></div>
<p>Colors:</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb10" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> red     <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> green   <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> blue    <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> cyan    <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> magenta <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> yellow  <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> black   <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> white   <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span></code></pre></div>
<h3 id="vertex-manipulation">Vertex manipulation</h3>
<ol>
<li><p><code class="verbatim">quad</code></p>
<p>A <code class="verbatim">quad</code> is made of two triangles:</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb11" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quad(a, b, c,  d):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [(a, b, c), (b, c, d)]</span></code></pre></div></li>
<li><p><code class="verbatim">line</code></p>
<p>A <code class="verbatim">line</code> is also represented as two
triangles, except that it is only defined as two points and a <span
class="math inline"><em>w</em><em>i</em><em>d</em><em>t</em><em>h</em></span>.</p>
<p>Its implementation is more complex because each of the two initial
points must splitted in two new points in order to generate a line with
a width. The position of those new points is computed by shifting them
towards each of the normal directions by an amount of <span
class="math inline"><em>w</em><em>i</em><em>d</em><em>t</em><em>h</em>/2</span>,
thus making the distance between them equal to <span
class="math inline"><em>w</em><em>i</em><em>d</em><em>t</em><em>h</em></span>.</p>
<p>Addition to <strong><code class="verbatim">pymgen</code></strong></p>
<div class="sourceCode" id="cb12" data-noweb-ref="pymgen"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> line(a, b, width<span class="op">=</span><span class="fl">.01</span>):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the tangent components (that once flipped become the normal components).</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> (b[<span class="dv">0</span>] <span class="op">-</span> a[<span class="dv">0</span>])</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    dy <span class="op">=</span> (b[<span class="dv">1</span>] <span class="op">-</span> a[<span class="dv">1</span>])</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the width:</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> width <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> math.sqrt(dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">*=</span> width</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    dy <span class="op">*=</span> width</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shift the points.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    a1, a2, b1, b2 <span class="op">=</span> <span class="bu">list</span>(a), <span class="bu">list</span>(a), <span class="bu">list</span>(b), <span class="bu">list</span>(b)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    a1[<span class="dv">0</span>] <span class="op">-=</span> dy<span class="op">;</span> a1[<span class="dv">1</span>] <span class="op">+=</span> dx<span class="op">;</span> a2[<span class="dv">0</span>] <span class="op">+=</span> dy<span class="op">;</span> a2[<span class="dv">1</span>] <span class="op">-=</span> dx</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    b1[<span class="dv">0</span>] <span class="op">-=</span> dy<span class="op">;</span> b1[<span class="dv">1</span>] <span class="op">+=</span> dx<span class="op">;</span> b2[<span class="dv">0</span>] <span class="op">+=</span> dy<span class="op">;</span> b2[<span class="dv">1</span>] <span class="op">-=</span> dx</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [(a1, a2, b1), (a2, b1, b2)]</span></code></pre></div></li>
</ol>
<h2 id="code-blocks">Code blocks</h2>
<p>This Python one-liner is <code class="verbatim">pymgen</code>'s
equivalent of the colorful square specification, which is for now the
only image that has been generated:</p>
<p><strong><code class="verbatim">usage</code></strong></p>
<div class="sourceCode" id="usage"><pre
class="sourceCode python"><code class="sourceCode python"><span id="usage-1"><a href="#usage-1" aria-hidden="true" tabindex="-1"></a>imgspec(quad(rt <span class="op">+</span> y, lt <span class="op">+</span> m, rb <span class="op">+</span> c, lb <span class="op">+</span> k), <span class="dv">64</span>, <span class="dv">64</span>)</span></code></pre></div>
<h3 id="display-an-image-spec">Display an image spec</h3>
<p>This is just a matter of using <code class="verbatim">LitLib</code>'s
<code class="verbatim">include.pl</code> to fetch the given code block,
with the added <code class="verbatim">pymgen</code> dependency and to
execute it with Python.</p>
<p><strong><code class="verbatim">spec</code></strong></p>
<div class="sourceCode" id="spec" data-var="definition=&quot;&quot;"
wrap="example"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="spec-1"><a href="#spec-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./litlib/include.pl</span> imgen.org <span class="st">&quot;:noweb pymgen </span><span class="va">$definition</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="ex">python</span></span></code></pre></div>
<pre class="example"><code>1 1 1 1 0
0 1 1 0 1
1 0 0 1 1
0 0 0 0 0

2 3

0 1 2
1 2 3

64 64
</code></pre>
<h3 id="generate-the-image">Generate the image</h3>
<p>This is basically the same thing, except that the image is also
forwarded to the <code class="verbatim">imgen</code> binary.</p>
<p><strong><code class="verbatim">py</code></strong></p>
<div class="sourceCode" id="py"
data-var="definition=&quot;&quot; destination=&quot;&quot;"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="py-1"><a href="#py-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$definition</span><span class="st">&quot;</span> <span class="kw">]]</span> <span class="kw">||</span> <span class="kw">{</span> <span class="bu">echo</span> <span class="st">&quot;A definition code block is required.&quot;</span><span class="kw">;</span> <span class="bu">exit</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="py-2"><a href="#py-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">[[</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$destination</span><span class="st">&quot;</span> <span class="kw">]];</span> <span class="cf">then</span></span>
<span id="py-3"><a href="#py-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">destination</span><span class="op">=</span><span class="st">&quot;images/imgen/</span><span class="va">$definition</span><span class="st">.png&quot;</span></span>
<span id="py-4"><a href="#py-4" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="py-5"><a href="#py-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$(</span><span class="fu">dirname</span> <span class="st">&quot;</span><span class="va">$dest</span><span class="st">&quot;</span><span class="va">)</span><span class="st">&quot;</span></span>
<span id="py-6"><a href="#py-6" aria-hidden="true" tabindex="-1"></a><span class="ex">./litlib/include.pl</span> imgen.org <span class="st">&quot;:noweb pymgen </span><span class="va">$definition</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="ex">python</span> <span class="op">&gt;</span> removeme.imspec</span>
<span id="py-7"><a href="#py-7" aria-hidden="true" tabindex="-1"></a><span class="ex">./bin/imgen</span> removeme.imspec <span class="st">&quot;</span><span class="va">$destination</span><span class="st">&quot;</span></span>
<span id="py-8"><a href="#py-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> removeme.imspec</span></code></pre></div>
<div class="RESULTS drawer">
<p><img src="images/imgen/usage.png" /></p>
</div>
<h2 id="usage-1">Usage</h2>
<h3 id="colorful-square-with-added-line">Colorful square, with added
line</h3>
<p>This is the same basic example, but with an additional line going
from the left-bottom point to the right-top one. Also the width of this
image is doubled to 128.</p>
<p><strong><code
class="verbatim">colorful-square+line</code></strong></p>
<div class="sourceCode" id="colorful-square+line"><pre
class="sourceCode python"><code class="sourceCode python"><span id="colorful-square+line-1"><a href="#colorful-square+line-1" aria-hidden="true" tabindex="-1"></a>imgspec(quad(rt <span class="op">+</span> y, lt <span class="op">+</span> m, rb <span class="op">+</span> c, lb <span class="op">+</span> k) <span class="op">+</span> line(lb, rt, <span class="fl">.1</span>), <span class="dv">128</span>, <span class="dv">64</span>)</span></code></pre></div>
<div class="RESULTS drawer">
<p><img src="images/imgen/colorful-square+line.png" /></p>
</div>
<p>Here is what the spec looks like<a href="#fn1" class="footnote-ref"
id="fnref1" role="doc-noteref"><sup>1</sup></a>:</p>
<pre class="example"><code>1 1 1 1 0
0 1 1 0 1
1 0 0 1 1
0 0 0 0 0
-0.035355339059327376 0.035355339059327376 0 0 0
0.035355339059327376 -0.035355339059327376 0 0 0
0.9646446609406726 1.0353553390593273 0 0 0
1.0353553390593273 0.9646446609406726 0 0 0

2 3

0 1 2
1 2 3
4 5 6
5 6 7

128 64
</code></pre>
<h3 id="a-less-trivial-example-sierpiński-triangle">A less trivial
example, Sierpiński triangle</h3>
<p>Constructing the coordinates of a Sierpiński triangle is a matter of
recursing through each subtriangle, this is done in <code
class="verbatim">sierec</code>. Those subtriangles are themselves
constructed using midpoints computed with the <code
class="verbatim">mid</code> function.</p>
<p>Addition to <strong><code
class="verbatim">sierpiński</code></strong></p>
<div class="sourceCode" id="cb15" data-noweb-ref="sierpiński"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(l, r):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (l[<span class="dv">0</span>] <span class="op">+</span> r[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span>, (l[<span class="dv">1</span>] <span class="op">+</span> r[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sierec(a, b, c, n<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span>: <span class="cf">return</span> [(a, b, c)]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    ab, ac, bc <span class="op">=</span> mid(a, b), mid(a, c), mid(b, c)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sierec(a, ab, ac, n) <span class="op">+</span> sierec(b, ab, bc, n) <span class="op">+</span> sierec(c, ac, bc, n)</span></code></pre></div>
<p>Then <code class="verbatim">sierpinski</code> assembles the triangles
into lines, with the help of <code class="verbatim">toline</code>:</p>
<p>Addition to <strong><code
class="verbatim">sierpiński</code></strong></p>
<div class="sourceCode" id="cb16" data-noweb-ref="sierpiński"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> toline(tri, width):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    a, b, c <span class="op">=</span> tri</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> line(a, b, width) <span class="op">+</span> line(a, c, width) <span class="op">+</span> line(b, c, width)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sierpinski(a, b, c, n<span class="op">=</span><span class="dv">1</span>, width<span class="op">=</span><span class="fl">.01</span>):</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [ triangle_line</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>             <span class="cf">for</span> triangle      <span class="kw">in</span> sierec(a, b, c, n)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>             <span class="cf">for</span> triangle_line <span class="kw">in</span> toline(triangle, width) ]</span></code></pre></div>
<p>Since the sierpinski triangle uses equilateral triangle, the size of
the canvas mush be adjusted so that the length of the width is equal to
the length of the other sides of the triangles. This is done by solving
<span class="math inline">$(\frac{width}{2})^2 + height^2 =
side^2$</span>, with <span
class="math inline"><em>s</em><em>i</em><em>d</em><em>e</em></span>
being the length of the left and right sides of the triangle. Since we
want <span
class="math inline"><em>s</em><em>i</em><em>d</em><em>e</em></span> to
be equal to <span
class="math inline"><em>w</em><em>i</em><em>d</em><em>t</em><em>h</em></span>,
this can be rewritten as <span class="math inline">$(\frac{width}{2})^2
+ height^2 = width^2$</span>, which eventually gives the formula <span
class="math inline">$height = \sqrt{\frac{3 \times width^2}{4}}$</span>,
implemented below:</p>
<p>Addition to <strong><code
class="verbatim">sierpiński</code></strong></p>
<div class="sourceCode" id="cb17" data-noweb-ref="sierpiński"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> height():</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>(math.sqrt((<span class="dv">3</span> <span class="op">*</span> width <span class="op">*</span> width) <span class="op">/</span> <span class="dv">4</span>))</span></code></pre></div>
<p>Only image specification generation remains, with a reasonable width
and a turquoise background:</p>
<p>Addition to <strong><code
class="verbatim">sierpiński</code></strong></p>
<div class="sourceCode" id="cb18" data-noweb-ref="sierpiński"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> (<span class="dv">0</span>, <span class="fl">.6</span>, <span class="fl">.7</span>) <span class="co"># Turquoise.</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>imgspec(quad(lb<span class="op">+</span>t, rb<span class="op">+</span>t, lt<span class="op">+</span>t, rt<span class="op">+</span>t) <span class="op">+</span> sierpinski(lb, rb, mt, <span class="dv">7</span>, <span class="fl">.0015</span>), width, height())</span></code></pre></div>
<div class="RESULTS drawer">
<p><img src="images/imgen/sierpiński.png" /></p>
</div>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>The line vertices are very easy to
spot.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
